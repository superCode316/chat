<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="UTF-8">
    <title>聊天界面</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/semantic-ui@2.4.2/dist/semantic.min.css">
    <link rel="stylesheet" href="../static/css/me.css" th:href="@{/css/me.css}">
    <meta name="viewport" content="width=1024">
</head>
<body style="overflow: auto">

<div class="main_inner">
    <div class="panel">
        <div class="header">
            <div class="avatar">
                <img class="ui img rounded image" src="../static/images/unsplash.jpg" style="width: 50px; height: 50px">
            </div>
            <div class="info">
                <h3 class="nickname m-nickname-position">
                    用户名
                </h3>
                <!--                    <label class="m-text-size" style="position: relative; top: 0;bottom: 0;left: 10px;right: 0">个性签名</label>-->
            </div>
        </div>
        <div class="search_bar">
            <div class="ui icon inverted transparent input">
                <input type="text" placeholder="搜索">
                <i class="search link icon"></i>
            </div>
        </div>
        <div class="ui inverted section divider"></div>
        <div class="nav_view" style="overflow: auto">
            <!--好友列表-->
            <div class="ui selection list" id="user_list">
            </div>
        </div>
    </div>
    <div class="box">
        <!--聊天框顶部标题-->
        <div class="box_hd">
            <div class="title_wrap">
                <div class="title poi" id="header">
                    <a class="title_name title poi">用户名</a>
                    <i class="web_wechat_down_icon"></i>
                </div>
            </div>
        </div>
        <!--聊天框-->
        <div class="box_bd scroll-wrapper" style="position: absolute">
            <div class="box_bd scroll-content" style="margin-bottom: 0;margin-right: 0;height: 494px;overflow: auto !important;" id="msg-content">
                <!--                    -->
                <div class="box_bd scroll-content" style="">
                    <div  class="message-you you">
                        <img onclick="show()" class="avatar-chat-you" src="../static/images/unsplash.jpg">
                        <div class="content">
                            <div class="bubble bubble_default right">
                                <div class="bubble_cont">
                                    <div class="plain">
                                        <pre>这是一条消息这是一条消息这是一条消息这是一条消息这是一条消息这是一条消息这是一条消息这是一条消息这是一条消息这是一条消息这是一条消息</pre>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!--聊天框底部输入框和发送按钮-->
        <div class="box_ft">
            <div class="toolbar">
                <!--可以作为表情包等用途-->
            </div>
            <div class="content">
                <textarea id="text" name="text" class="flex"></textarea>
                <div class="action">
                    <button id="submit"  class="ui sumbit button btn" onclick="">发送</button>
                </div>
            </div>
        </div>
        <div class="ui card" style="display: none;position: absolute; top: 0;left: 100px">
            <div class="image">
                <img src="../static/images/unsplash.jpg">
            </div>
            <div class="content">
                <a class="header">Kristy</a>
                <div class="description">
                    Kristy is an art director living in New York.
                </div>
            </div>
            <button id="closeBtn" class="ui button">
                关闭
            </button>
        </div>
    </div>
</div>
<script src="https://cdn.staticfile.org/jquery/1.10.2/jquery.min.js"></script>
<script src="http
s://cdn.jsdelivr.net/npm/semantic-ui@2.4.2/dist/semantic.min.js"></script>
<script>
    let count = 0;
    const userid = Number.parseInt(localStorage.getItem('userid'));
    const def_your_message = '<div class="box_bd scroll-content">\n' +
        '                        <div class="message-you you">\n' +
        '                            <img onclick="show()" class="avatar-chat-you" src="../static/images/unsplash.jpg">\n' +
        '                            <div class="content">\n' +
        '                                <div class="bubble bubble_default right">\n' +
        '                                    <div class="bubble_cont">\n' +
        '                                        <div class="plain">\n' +
        '                                            <pre>CONTENT</pre>\n' +
        '                                        </div>\n' +
        '                                    </div>\n' +
        '                                </div>\n' +
        '                            </div>\n' +
        '                        </div>\n' +
        '                    </div>';
    const def_my_message = '<div class="box_bd scroll-content">\n' +
        '                        <div class="message-me me">\n' +
        '                            <img class="avatar-chat-me" src="../static/images/unsplash.jpg">\n' +
        '                            <div class="content">\n' +
        '                                <div class="bubble bubble_primary right">\n' +
        '                                    <div class="bubble_cont">\n' +
        '                                        <div class="plain">\n' +
        '                                            <pre>CONTENT</pre>\n' +
        '                                        </div>\n' +
        '                                    </div>\n' +
        '                                </div>\n' +
        '                            </div>\n' +
        '                        </div>\n' +
        '                    </div>' ;
    const def_group_tab = '\n' +
        '                    <div class="item" style="background: #2e3238;margin-bottom: 0.5em">\n' +
        '                        <img class="ui rounded image" style="margin-left: 1em; width: 40px; height: 40px" onerror="this.src=\'/static/images/avatar.png\';" src="AVATAR_URL" alt="头像">\n' +
        '                        <div class="content" >\n' +
        '                            <div class="header" style="color: white">NAME</div>\n' +
        '                        </div>\n' +
        '                    </div>';
    const connectError = '<h4 id="socketReconnect">服务器连接丢失<a onclick="configSocket()">&nbsp重新连接</a></h4>\n';
    const saved_group = JSON.parse(localStorage.getItem('groups_info'));
    const messageList = document.getElementById('msg-content');
    $("#submit").click(function () {
        const textArea = $("#text");
        let data = textArea.val();
        textArea.val('');
        websocket.send(JSON.stringify({groupId:12,content:data}))
    });
    for (let i of saved_group) {
        const newTab = def_group_tab.replace('AVATAR_URL', i.profileUrl).replace('NAME', i.name);
        console.log(newTab);
        document.getElementById('user_list').innerHTML+=newTab;
    }
    (async function(){
        const messages = await $.ajax('/message/get-group?receiver=12');
        for (let i of messages.data){
            await handleMessage(i)
        }
    })();
    function addMyMessage(msg) {
        const one = def_my_message.replace('CONTENT', msg.content || msg);
        addMessage(one);
    }
    async function handleMessage(msgBody) {
        console.log(msgBody);
        if (msgBody.senderId === undefined || msgBody.senderId === userid || msgBody.senderId === String(userid)) {
            return addMyMessage(msgBody);
        }
        let { senderId } = msgBody;
        let userinfo;
        if ((userinfo=localStorage.getItem('userinfo_' + senderId)) === null) {
            userinfo = await (getNewUser(senderId));
        }
        const one = def_your_message.replace('CONTENT', msgBody.content);
        addMessage(one)
    }
    async function getNewUser(uid) {
        const res = await $.ajax('/user/info?uid='+uid);
        if (res.code === 0) {
            const userInfo= res.data;
            localStorage.setItem('userinfo_' + uid, userInfo);
            return userInfo;
        }
        return null;
    }
    function addMessage(msgHtml) {
        count++;
        messageList.innerHTML += msgHtml;
    }
    // setInterval(refreshMessage, 2000);
    const ticket = window.location.href.split('ticket=')[1];
    let websocket;

    function configSocket() {
        const rec = document.getElementById('socketReconnect');

        if (rec !== null)
            document.getElementById('header').removeChild(rec);

        websocket = new WebSocket("ws://"+window.location.host+"/websocket/"+ticket);

        //连接发生错误的回调方法
        websocket.onerror = function(){
            alert('无法连接至服务器')
        };

        //连接成功建立的回调方法
        websocket.onopen = function(event){
            console.log('连接成功')
        };

        //接收到消息的回调方法
        websocket.onmessage = function(event){
            handleMessage(JSON.parse(event.data))
        };

        //连接关闭的回调方法
        websocket.onclose = function(){
            let t = 0;
            function retry() {
                if (t < 10)
                    try {
                        t++;
                        websocket = new WebSocket('ws://'+window.location.host + "/websocket/"+ticket);
                        console.log('重连成功')
                    } catch (e) {
                        console.log(e);
                        setTimeout(retry, 1000);
                        console.log('retry ' + t + ' times');
                    }
                else
                    showSocketError();
            }
            console.log('retrying...');
            retry();
        };

        let isclose = false;

        //监听窗口关闭事件，当窗口关闭时，主动去关闭websocket连接，防止连接还没断开就关闭窗口，server端会抛异常。
        window.onbeforeunload = function(){
            isclose = true;
            websocket.close();
        };
    }
    function showSocketError() {
        console.log('showSocketError');
        document.getElementById('header').innerHTML += connectError;
    }
    configSocket();
    messageList.scrollTop = messageList.scrollHeight;
</script>
<script>
    $('#closeBtn')
        .on('click', function() {
            $(this)
                .closest('.ui.card')
                .css("display","none");
        });

    function show() {
        $('.ui.card').css("display", "block");
    }

    $("#text").keyup(function (event) {
        if (event.which === 13) {
            const textArea = $("#text");
            let data = textArea.val();
            addMyMessage(data);
            textArea.val('');
            $.ajax({
                type: "post",
                url: "/message/send",
                data: {receiver: 12,content:data},
                withCredentials: true
            });
        }
    })

</script>
</body>

</html>